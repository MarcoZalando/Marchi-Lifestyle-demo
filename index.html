<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayUp - Interactive Platform Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass-panel {
                @apply bg-white border border-gray-200 shadow-sm rounded-xl;
            }
            .btn-primary {
                @apply bg-teal-600 text-white hover:bg-teal-700 transition-colors px-4 py-2 rounded-lg font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed;
            }
            .btn-danger {
                @apply bg-red-50 text-red-600 hover:bg-red-100 transition-colors px-3 py-1 rounded-lg text-sm font-medium border border-red-200;
            }
            .mobile-screen {
                @apply bg-gray-100 overflow-hidden relative;
                width: 300px;
                height: 600px;
                border-radius: 30px;
                border: 8px solid #1f2937;
            }
            /* Navigation Active State */
            .nav-item.active {
                @apply bg-teal-50 text-teal-700;
            }
            .nav-item {
                @apply cursor-pointer select-none;
            }
            /* View Toggle Active State */
            .view-toggle-btn.active {
                @apply bg-teal-600 text-white shadow-inner;
            }
            /* Planning View specific styles */
            .day-header {
                @apply font-medium text-gray-700 text-sm py-2 border-b border-gray-200;
            }
            .calendar-cell {
                @apply p-2 text-xs border border-gray-100 min-h-[100px] hover:bg-gray-50 transition-colors cursor-pointer relative;
            }
        }
        
        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        /* Simple transition for views */
        .view-section {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-10">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-8 h-8 bg-teal-600 rounded-lg flex items-center justify-center text-white font-bold">P</div>
            <span class="text-xl font-bold text-gray-800">PayUp</span>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <div onclick="navigateTo('dashboard')" id="nav-dashboard" class="nav-item active flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition-colors">
                <span>üìä</span> Dashboard
            </div>
            <div onclick="navigateTo('planning')" id="nav-planning" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition-colors">
                <span>üìÖ</span> Planning
            </div>
            <div onclick="navigateTo('personeel')" id="nav-personeel" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition-colors">
                <span>üë•</span> Personeel
            </div>
            <div onclick="navigateTo('verloning')" id="nav-verloning" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition-colors">
                <span>üí∞</span> Verloning
            </div>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="text-xs font-bold text-indigo-800 mb-1">FairShift Status</p>
                <p class="text-sm text-indigo-600" id="sidebar-status">Actief (Demo Modus)</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <!-- Top Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 md:px-8 shrink-0">
            <h2 class="text-lg font-semibold text-gray-700" id="page-title">Dashboard: Vrijdagavond Service</h2>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-gray-800">Caf√© 't Gouwe Haantje</p>
                    <p class="text-xs text-gray-500">Manager: Nico</p>
                </div>
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 border border-gray-300">
                    üë§
                </div>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-auto p-6 md:p-8 relative">
            
            <!-- VIEW: DASHBOARD (Default) -->
            <div id="view-dashboard" class="view-section max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column: Operations Control -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="glass-panel p-5">
                            <p class="text-sm text-gray-500 mb-1">Huidige Omzet (Live)</p>
                            <p class="text-2xl font-bold text-gray-800">‚Ç¨ 2.450</p>
                            <p class="text-xs text-green-600 mt-1">‚ñ≤ 12% vs vorige week</p>
                        </div>
                        <div class="glass-panel p-5 border-l-4 border-teal-500">
                            <p class="text-sm text-gray-500 mb-1">Beschikbare FairShift Pot</p>
                            <p class="text-2xl font-bold text-teal-700" id="pot-display">‚Ç¨ 0,00</p>
                            <p class="text-xs text-gray-400 mt-1">Vrijgevallen loonbudget</p>
                        </div>
                        <div class="glass-panel p-5">
                            <p class="text-sm text-gray-500 mb-1">Loonkosten %</p>
                            <p class="text-2xl font-bold text-gray-800" id="wage-percent">28.5%</p>
                            <p class="text-xs text-gray-400 mt-1">Doelstelling: < 30%</p>
                        </div>
                    </div>

                    <!-- Live Roster -->
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-800 text-lg">Live Rooster & Aanwezigheid</h3>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full border border-green-200"> Dienst bezig (17:00 - 01:00)</span>
                        </div>
                        <div class="space-y-4" id="roster-list">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Financi√´le Impact Analyse</h3>
                        <p class="text-sm text-gray-500 mb-4">Bekijk het effect van FairShift op je marge.</p>
                        <div class="chart-wrapper">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Mobile Simulation -->
                <div class="lg:col-span-1 flex flex-col items-center justify-start space-y-4">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wide">Live Medewerker View (Lisa)</h3>
                    <div class="mobile-screen shadow-2xl flex flex-col bg-white">
                        <div class="bg-teal-600 text-white p-4 pt-8 pb-6 rounded-b-3xl shadow-md z-10 relative">
                            <div class="flex justify-between items-center">
                                <div><p class="text-xs opacity-80">Goedenavond,</p><p class="text-lg font-bold">Lisa</p></div>
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-sm">üîî</div>
                            </div>
                        </div>
                        <div class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">Ingeklokt</span>
                                    <span class="text-xs text-gray-400">17:00 - 23:00</span>
                                </div>
                                <p class="font-bold text-gray-800 text-lg mb-1">Bediening Terras</p>
                                <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                                    <div class="text-gray-500 text-xs">Uurloon Basis</div>
                                    <div class="font-mono font-bold text-gray-700">‚Ç¨ 13,50</div>
                                </div>
                            </div>
                            <div id="mobile-fairshift-alert" class="hidden transform transition-all duration-500 ease-in-out">
                                <div class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg relative overflow-hidden">
                                    <div class="absolute -right-4 -top-4 text-white opacity-10 text-6xl font-bold">‚Ç¨</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-xl">üöÄ</span><span class="font-bold">FairShift Actief!</span>
                                    </div>
                                    <p class="text-indigo-100 text-sm leading-snug mb-3">Jullie vangen de afwezigheid samen op. Top teamwork!</p>
                                    <div class="bg-white/20 rounded-lg p-2 flex justify-between items-center">
                                        <span class="text-xs font-medium">Bonus/uur:</span>
                                        <span class="text-lg font-bold text-yellow-300" id="mobile-bonus-amount">+ ‚Ç¨ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-white p-3 rounded-xl shadow-sm text-center">
                                    <p class="text-xs text-gray-400">Gewerkt</p><p class="font-bold text-gray-800">2u 15m</p>
                                </div>
                                <div class="bg-white p-3 rounded-xl shadow-sm text-center">
                                    <p class="text-xs text-gray-400">Verdiend</p><p class="font-bold text-teal-600" id="mobile-earned">‚Ç¨ 30,38</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 border-t border-gray-200 flex justify-around text-2xl text-gray-300">
                            <span class="text-teal-600">üè†</span><span>üìÖ</span><span>üí¨</span><span>‚öôÔ∏è</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PLANNING -->
            <div id="view-planning" class="view-section hidden max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    
                    <div class="flex gap-2">
                        <button onclick="changePeriod(-1)" class="bg-white border border-gray-300 px-3 py-1 rounded text-gray-600 hover:bg-gray-50">‚ùÆ Vorige <span id="prev-period-text">Week</span></button>
                        <button onclick="changePeriod(1)" class="bg-white border border-gray-300 px-3 py-1 rounded text-gray-600 hover:bg-gray-50">Volgende <span id="next-period-text">Week</span> ‚ùØ</button>
                    </div>
                    
                    <div class="flex rounded-lg overflow-hidden border border-gray-300 shadow-sm">
                        <button id="view-week-btn" onclick="changeView('week')" class="view-toggle-btn px-3 py-1 text-sm font-medium transition-colors active">Week</button>
                        <button id="view-month-btn" onclick="changeView('month')" class="view-toggle-btn px-3 py-1 text-sm font-medium transition-colors bg-white text-gray-700 hover:bg-gray-50 border-l border-gray-300">Maand</button>
                        <button id="view-year-btn" onclick="changeView('year')" class="view-toggle-btn px-3 py-1 text-sm font-medium transition-colors bg-white text-gray-700 hover:bg-gray-50 border-l border-gray-300">Jaar</button>
                    </div>

                    <span class="font-bold text-gray-700 text-lg" id="planning-period-display">Week 47 (18 - 24 Nov)</span>
                    <button onclick="showCustomAlert('Opgeslagen', 'Het rooster is succesvol opgeslagen en gedeeld met medewerkers.')" class="btn-primary text-sm">+ Rooster Opslaan</button>
                </div>
                
                <div id="planning-content-area" class="min-h-[500px]">
                    
                    <!-- Month View Container -->
                    <div id="planning-month-view" class="hidden glass-panel p-4 h-full">
                        <div id="month-calendar-grid" class="grid grid-cols-7 gap-px text-center">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                    
                    <!-- Year View Container -->
                    <div id="planning-year-view" class="hidden glass-panel p-6 h-full">
                        <h4 class="text-xl font-bold text-gray-700 mb-4">Jaaroverzicht: <span id="year-display">2025</span> - Kerncijfers</h4>
                        <div id="year-month-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                    
                    <!-- Week Grid Container -->
                    <div id="planning-week-view">
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                            <div class="grid grid-cols-8 bg-gray-50 border-b border-gray-200 text-sm font-medium text-gray-500 text-center py-3">
                                <div class="col-span-1 text-left px-4">Medewerker</div>
                                <div id="day-0-header">Ma</div>
                                <div id="day-1-header">Di</div>
                                <div id="day-2-header">Wo</div>
                                <div id="day-3-header">Do</div>
                                <div id="day-4-header">Vr</div>
                                <div id="day-5-header">Za</div>
                                <div id="day-6-header">Zo</div>
                            </div>
                            <div class="divide-y divide-gray-100" id="planning-grid">
                                <!-- Injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PERSONEEL -->
            <div id="view-personeel" class="view-section hidden max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <input type="text" placeholder="Zoek medewerker..." class="border border-gray-300 rounded-lg px-4 py-2 w-64 focus:outline-none focus:border-teal-500">
                    <button onclick="toggleAddForm()" class="btn-primary text-sm">+ Nieuwe Medewerker</button>
                </div>
                
                <!-- Medewerker Toevoegen Formulier -->
                <div id="add-employee-form-container" class="glass-panel p-6 mb-6 hidden">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 border-b pb-2">Gegevens Nieuwe Medewerker</h3>
                    <form id="add-employee-form" onsubmit="addEmployee(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-name" class="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                            <input type="text" id="new-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="new-role" class="block text-sm font-medium text-gray-700 mb-1">Functie (bv. Barman)</label>
                            <input type="text" id="new-role" name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="new-contract" class="block text-sm font-medium text-gray-700 mb-1">Contract</label>
                            <select id="new-contract" name="contract" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <option value="0 uren">0 uren</option>
                                <option value="8u">8u</option>
                                <option value="16u">16u</option>
                                <option value="32u">32u</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-wage" class="block text-sm font-medium text-gray-700 mb-1">Uurloon (‚Ç¨)</label>
                            <input type="number" id="new-wage" name="wage" required min="10" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="md:col-span-2 flex gap-4 mt-2">
                            <button type="submit" class="w-1/2 bg-teal-600 text-white font-bold py-2.5 rounded-lg hover:bg-teal-700 transition duration-300 shadow-md">
                                Opslaan en Toevoegen
                            </button>
                            <button type="button" onclick="toggleAddForm()" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition duration-300">
                                Annuleren
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-sm uppercase tracking-wider">
                                <th class="p-4">Naam</th>
                                <th class="p-4">Functie</th>
                                <th class="p-4">Contract</th>
                                <th class="p-4">Uurloon</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Actie</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 text-sm" id="employee-table-body">
                            <!-- Injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: VERLONING -->
            <div id="view-verloning" class="view-section hidden max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 text-lg" id="payroll-title-period">Overzicht</h3>
                    <!-- NEW: Payroll View Toggles -->
                    <div class="flex rounded-lg overflow-hidden border border-gray-300 shadow-sm bg-white">
                        <button id="pay-week-btn" onclick="changePayrollView('week')" class="px-4 py-2 text-sm font-medium transition-colors bg-teal-600 text-white">Week</button>
                        <button id="pay-month-btn" onclick="changePayrollView('month')" class="px-4 py-2 text-sm font-medium transition-colors bg-white text-gray-700 hover:bg-gray-50 border-l border-gray-300">Maand</button>
                        <button id="pay-year-btn" onclick="changePayrollView('year')" class="px-4 py-2 text-sm font-medium transition-colors bg-white text-gray-700 hover:bg-gray-50 border-l border-gray-300">Jaar</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-panel p-6">
                        <p class="text-gray-500 text-sm mb-1" id="payroll-cost-label">Totale Loonkosten</p>
                        <p class="text-3xl font-bold text-gray-800" id="payroll-total-cost">‚Ç¨ 0,00</p>
                        <div class="w-full bg-gray-100 h-2 rounded-full mt-4"><div class="bg-teal-500 h-2 rounded-full" style="width: 65%"></div></div>
                    </div>
                    <div class="glass-panel p-6">
                        <p class="text-gray-500 text-sm mb-1" id="payroll-hours-label">Totaal Uren</p>
                        <p class="text-3xl font-bold text-gray-800" id="payroll-total-hours">0 u</p>
                        <p class="text-xs text-gray-400 mt-2">Gecalculeerd op basis van rooster</p>
                    </div>
                    <div class="glass-panel p-6 flex flex-col justify-center items-start">
                        <p class="text-gray-500 text-sm mb-3">Periode afsluiten</p>
                        <button onclick="handlePayrollExport()" id="payroll-export-btn" class="btn-primary w-full flex justify-center items-center gap-2">
                            <span>üìÑ</span> Export naar Salaris
                        </button>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-sm uppercase tracking-wider">
                                <th class="p-4">Medewerker</th>
                                <th class="p-4">Functie</th>
                                <th class="p-4">Uurloon</th>
                                <th class="p-4">Totaal Uren</th>
                                <th class="p-4">Totaal Kosten</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 text-sm" id="payroll-table-body">
                            <!-- Injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- Action Modal (Hidden by default) -->
        <div id="action-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ü§í</div>
                    <h3 class="text-2xl font-bold text-gray-800">Ziekmelding verwerken</h3>
                    <p class="text-gray-600 mt-2">Je staat op het punt <span id="modal-employee-name" class="font-bold">Sarah</span> ziek te melden.</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700 font-bold">Vrijvallend Budget:</span>
                        <span class="text-teal-600 font-bold text-xl">‚Ç¨ 72,00</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <button onclick="activateFairShift()" class="w-full bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 transition shadow-lg flex items-center justify-center gap-2">
                        <span>üöÄ</span> Activeer FairShift
                    </button>
                    <button onclick="openReplacementModal()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg flex items-center justify-center gap-2">
                        <span>üîÑ</span> Zoek Vervanger (Handmatig)
                    </button>
                    <button onclick="closeModal()" class="w-full bg-white text-gray-600 py-3 rounded-lg font-medium border border-gray-300 hover:bg-gray-50 transition">
                        Annuleren
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Replacement Selection Modal -->
        <div id="replacement-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Selecteer Vervanger</h3>
                <p class="text-sm text-gray-600 mb-4">Beschikbare collega's voor de dienst van <span id="replacement-sick-name" class="font-semibold"></span>:</p>
                
                <div id="replacement-list" class="space-y-3 max-h-60 overflow-y-auto p-1">
                    <!-- Replacement employee buttons injected here -->
                </div>

                <button onclick="closeReplacementModal()" class="w-full bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition duration-300 mt-4">
                    Terug
                </button>
            </div>
        </div>

        <!-- DELETE CONFIRMATION MODAL (NEW) -->
        <div id="delete-confirmation-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Dienst Verwijderen</h3>
                <p class="text-sm text-gray-600 mb-4">Dit is een terugkerende dienst. Wat wil je doen?</p>
                
                <div class="space-y-3">
                    <button onclick="confirmDelete('single')" class="w-full flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200 hover:border-red-400 hover:bg-red-50 transition-all shadow-sm text-left group">
                        <span class="text-xl">üóëÔ∏è</span>
                        <div>
                             <span class="block font-bold text-gray-800 group-hover:text-red-700">Alleen deze dienst</span>
                             <span class="text-xs text-gray-500">Verwijder alleen voor deze week.</span>
                        </div>
                    </button>
                    <button onclick="confirmDelete('future')" class="w-full flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200 hover:border-red-400 hover:bg-red-50 transition-all shadow-sm text-left group">
                        <span class="text-xl">üõë</span>
                        <div>
                             <span class="block font-bold text-gray-800 group-hover:text-red-700">Vanaf nu (Stop reeks)</span>
                             <span class="text-xs text-gray-500">Verwijder deze en alle toekomstige.</span>
                        </div>
                    </button>
                </div>

                <button onclick="closeDeleteConfirmation()" class="w-full bg-gray-100 text-gray-600 font-bold py-2.5 rounded-lg hover:bg-gray-200 transition duration-300 mt-4">
                    Annuleren
                </button>
            </div>
        </div>

        <!-- EDIT EMPLOYEE MODAL -->
        <div id="edit-employee-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Medewerker Bewerken</h3>
                <form id="edit-employee-form" onsubmit="handleEditEmployeeSubmit(event)">
                    <input type="hidden" id="edit-emp-id">
                    <div class="grid gap-4">
                        <div>
                            <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">Naam</label>
                            <input type="text" id="edit-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="edit-role" class="block text-sm font-medium text-gray-700 mb-1">Functie</label>
                            <input type="text" id="edit-role" name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="edit-contract" class="block text-sm font-medium text-gray-700 mb-1">Contract</label>
                            <select id="edit-contract" name="contract" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <option value="0 uren">0 uren</option>
                                <option value="8u">8u</option>
                                <option value="16u">16u</option>
                                <option value="32u">32u</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-wage" class="block text-sm font-medium text-gray-700 mb-1">Uurloon (‚Ç¨)</label>
                            <input type="number" id="edit-wage" name="wage" required min="10" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="flex gap-3 mt-2">
                            <button type="submit" class="w-1/2 bg-teal-600 text-white font-bold py-2.5 rounded-lg hover:bg-teal-700 transition duration-300 shadow-md">
                                Opslaan
                            </button>
                            <button type="button" onclick="closeEditEmployeeModal()" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition duration-300">
                                Annuleren
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Shift Management Modal -->
        <div id="shift-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Dienst Beheren</h3>
                <form id="shift-form" onsubmit="handleShiftSubmit(event)">
                    <p class="text-sm text-gray-600 mb-4">Medewerker: <span id="shift-emp-name" class="font-semibold"></span> op <span id="shift-day-name" class="font-semibold"></span></p>
                    
                    <input type="hidden" id="shift-emp-id">
                    <input type="hidden" id="shift-day-index">

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label for="shift-start" class="block text-sm font-medium text-gray-700 mb-1">Starttijd</label>
                            <!-- NEW: Dropdown instead of input type="time" -->
                            <select id="shift-start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="shift-end" class="block text-sm font-medium text-gray-700 mb-1">Eindtijd</label>
                            <!-- NEW: Dropdown instead of input type="time" -->
                            <select id="shift-end" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <input id="shift-recurring" type="checkbox" class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="shift-recurring" class="ml-2 block text-sm text-gray-700">
                            Wekelijks herhalen (Elke week zichtbaar)
                        </label>
                    </div>
                    
                    <div class="flex gap-3 mt-4">
                        <button type="submit" id="shift-save-btn" class="w-2/3 btn-primary font-bold py-2.5">
                            Dienst Opslaan
                        </button>
                        <button type="button" onclick="closeShiftModal()" class="w-1/3 bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition duration-300">
                            Annuleren
                        </button>
                    </div>
                    
                    <div class="flex gap-2 mt-3">
                         <button type="button" id="shift-delete-btn" onclick="initiateDeleteShift()" class="w-1/2 text-red-600 text-sm font-medium py-2 border border-red-200 rounded-lg hover:bg-red-50 hidden">
                            üóëÔ∏è Verwijderen
                        </button>
                         <button type="button" id="shift-sick-btn" onclick="reportSickFromPlanning()" class="w-1/2 text-orange-600 text-sm font-medium py-2 border border-orange-200 rounded-lg hover:bg-orange-50 hidden">
                            ü§í Meld Ziek / Vervang
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Custom Alert/Toast Modal -->
        <div id="custom-alert-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all">
                <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-3">Melding</h3>
                <p id="alert-message" class="text-gray-600 mb-6"></p>
                <button onclick="closeCustomAlert()" class="btn-primary w-full">Begrepen</button>
            </div>
        </div>

    </main>

    <script>
        // --- Data State ---
        let currentShift = {};
        let sickEmployeeId = null;
        let sickDayIndex = null; // Track the day index for sickness replacement

        const dayNamesFull = ['Maandag', 'Dinsdag', 'Woensdag', 'Donderdag', 'Vrijdag', 'Zaterdag', 'Zondag'];
        const dayNamesShort = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];
        const monthNames = ["Januari", "Februari", "Maart", "April", "Mei", "Juni", "Juli", "Augustus", "September", "Oktober", "November", "December"];

        const state = {
            fairShiftActive: false,
            potTotal: 0,
            baseHourlyRate: 13.50,
            activeView: 'dashboard',
            payrollView: 'week', // week, month, year
            nextEmployeeId: 7,
            currentDate: new Date(2025, 10, 18), // Start on Mon Nov 18 2025
            currentView: 'week',
            employees: [
                { id: 1, name: 'Mark', role: 'Barman', status: 'active', avatar: 'https://randomuser.me/api/portraits/men/32.jpg', contract: '32u', wage: 14.50 },
                { id: 2, name: 'Lisa', role: 'Bediening', status: 'active', avatar: 'https://randomuser.me/api/portraits/women/44.jpg', contract: '32u', wage: 13.50 },
                { id: 3, name: 'Tom', role: 'Runner', status: 'active', avatar: 'https://randomuser.me/api/portraits/men/86.jpg', contract: '0 uren', wage: 11.00 },
                { id: 4, name: 'Sarah', role: 'Bediening', status: 'active', avatar: 'https://randomuser.me/api/portraits/women/68.jpg', contract: '16u', wage: 12.00 },
                { id: 5, name: 'Sophie', role: 'Afwasser', status: 'active', avatar: 'https://randomuser.me/api/portraits/women/15.jpg', contract: '8u', wage: 11.50 },
                { id: 6, name: 'Khalid', role: 'Keukenhulp', status: 'active', avatar: 'https://randomuser.me/api/portraits/men/55.jpg', contract: '0 uren', wage: 12.00 }
            ],
            // UPDATED Data Structure: Recurring shifts now have a startDate to support history
            // Shifts for demo are initialized in the past so they are visible now
            shifts: [
                { empId: 1, dayIndex: 0, start: '17:00', end: '01:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                { empId: 1, dayIndex: 3, start: '12:00', end: '20:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                { empId: 1, dayIndex: 4, start: '17:00', end: '01:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                
                { empId: 2, dayIndex: 0, start: '17:00', end: '01:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                { empId: 2, dayIndex: 2, start: '12:00', end: '20:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                { empId: 2, dayIndex: 4, start: '17:00', end: '01:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                
                { empId: 3, dayIndex: 4, start: '17:00', end: '01:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                { empId: 3, dayIndex: 5, start: '18:00', end: '02:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                
                { empId: 4, dayIndex: 4, start: '17:00', end: '01:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] },
                
                // Sophie on Tuesday (Day index 1)
                { empId: 5, dayIndex: 1, start: '10:00', end: '18:00', recurring: true, startDate: '2024-01-01', endDate: null, exceptions: [] }
            ]
        };

        // --- Time Slot Generator for Dropdowns ---
        function populateTimeSelects() {
            const startSelect = document.getElementById('shift-start');
            const endSelect = document.getElementById('shift-end');
            let optionsHTML = '<option value="" disabled selected>--:--</option>';
            
            // Range 10:00 - 23:30
            for (let h = 10; h <= 23; h++) {
                optionsHTML += `<option value="${h.toString().padStart(2, '0')}:00">${h.toString().padStart(2, '0')}:00</option>`;
                optionsHTML += `<option value="${h.toString().padStart(2, '0')}:30">${h.toString().padStart(2, '0')}:30</option>`;
            }
            // Range 00:00 - 02:00
            for (let h = 0; h <= 2; h++) {
                 optionsHTML += `<option value="${h.toString().padStart(2, '0')}:00">${h.toString().padStart(2, '0')}:00</option>`;
                 if (h < 2) { // Don't add 02:30 based on request "tot 02:00"
                    optionsHTML += `<option value="${h.toString().padStart(2, '0')}:30">${h.toString().padStart(2, '0')}:30</option>`;
                 }
            }
            
            startSelect.innerHTML = optionsHTML;
            endSelect.innerHTML = optionsHTML;
        }

        // --- Date Utility Functions ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function formatDate(date) {
            return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' }).replace('.', '');
        }
        
        function toISODate(date) {
            return date.toISOString().split('T')[0];
        }

        function timeToHours(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours + minutes / 60;
        }

        function getDuration(start, end) {
            let startH = timeToHours(start);
            let endH = timeToHours(end);
            
            if (endH < startH) {
                endH += 24; // crossing midnight
            }
            return endH - startH;
        }

        // --- Navigation Logic ---
        const pageTitles = {
            dashboard: 'Dashboard: Vrijdagavond Service',
            planning: 'Planning & Roosters',
            personeel: 'Personeelsdossiers',
            verloning: 'Verloning & Exports'
        };

        function navigateTo(viewId) {
            state.activeView = viewId;
            document.getElementById('page-title').innerText = pageTitles[viewId];

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'bg-teal-50', 'text-teal-700');
                el.classList.add('text-gray-600');
                if(el.id === `nav-${viewId}`) {
                    el.classList.add('active', 'bg-teal-50', 'text-teal-700');
                    el.classList.remove('text-gray-600');
                }
            });

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            if(viewId === 'personeel') renderEmployeeTable();
            if(viewId === 'planning') {
                renderPlanningHeader();
                renderPlanningContent();
            }
            if(viewId === 'verloning') renderPayroll();
            if(viewId !== 'personeel') document.getElementById('add-employee-form-container').classList.add('hidden');
        }
        
        // --- Planning View Toggles & Navigation ---

        function changeView(newView) {
            state.currentView = newView;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-teal-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
            });
            document.getElementById(`view-${newView}-btn`).classList.add('active', 'bg-teal-600', 'text-white');
            document.getElementById(`view-${newView}-btn`).classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
            
            renderPlanningHeader();
            renderPlanningContent();
        }

        function changePeriod(offset) {
            if (state.currentView === 'week') {
                const newDate = new Date(state.currentDate);
                newDate.setDate(state.currentDate.getDate() + (offset * 7));
                state.currentDate = getStartOfWeek(newDate);
            } else if (state.currentView === 'month') {
                const newDate = new Date(state.currentDate);
                newDate.setMonth(state.currentDate.getMonth() + offset);
                state.currentDate = new Date(newDate.getFullYear(), newDate.getMonth(), 1);
            } else if (state.currentView === 'year') {
                const newDate = new Date(state.currentDate);
                newDate.setFullYear(state.currentDate.getFullYear() + offset);
                state.currentDate = new Date(newDate.getFullYear(), 0, 1);
            }
            
            renderPlanningHeader();
            renderPlanningContent();
        }

        function renderPlanningHeader() {
            const display = document.getElementById('planning-period-display');
            const prevText = document.getElementById('prev-period-text');
            const nextText = document.getElementById('next-period-text');

            const startOfWeek = getStartOfWeek(state.currentDate);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const weekNum = getWeekNumber(startOfWeek);

            if (state.currentView === 'week') {
                display.textContent = `Week ${weekNum} (${formatDate(startOfWeek)} - ${formatDate(endOfWeek)})`;
                prevText.textContent = 'Week';
                nextText.textContent = 'Week';
                for(let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const dayNameShort = dayNamesFull[i].substring(0, 2);
                    document.getElementById(`day-${i}-header`).textContent = `${dayNameShort} ${date.getDate()}`;
                }

            } else if (state.currentView === 'month') {
                display.textContent = state.currentDate.toLocaleDateString('nl-NL', { month: 'long', year: 'numeric' });
                prevText.textContent = 'Maand';
                nextText.textContent = 'Maand';
            } else if (state.currentView === 'year') {
                display.textContent = state.currentDate.getFullYear();
                prevText.textContent = 'Jaar';
                nextText.textContent = 'Jaar';
            }
        }
        
        // --- Planning Content Dispatcher ---
        
        function renderPlanningContent() {
            document.getElementById('planning-week-view').classList.add('hidden');
            document.getElementById('planning-month-view').classList.add('hidden');
            document.getElementById('planning-year-view').classList.add('hidden');

            if (state.currentView === 'week') {
                document.getElementById('planning-week-view').classList.remove('hidden');
                renderWeekGrid();
            } else if (state.currentView === 'month') {
                document.getElementById('planning-month-view').classList.remove('hidden');
                renderMonthView();
            } else if (state.currentView === 'year') {
                document.getElementById('planning-year-view').classList.remove('hidden');
                renderYearView();
            }
        }

        // --- View Specific Renderers ---

        function renderMonthView() {
            const container = document.getElementById('month-calendar-grid');
            container.innerHTML = '';
            
            let headerHTML = dayNamesShort.map(day => `<div class="day-header bg-gray-100">${day}</div>`).join('');
            
            const firstDayOfMonth = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), 1);
            const startDayIndex = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1; 
            const daysInMonth = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 0).getDate();
            
            let cellsHTML = '';
            
            for(let i = 0; i < startDayIndex; i++) {
                cellsHTML += `<div class="calendar-cell bg-gray-50 border-gray-200"></div>`;
            }
            
            for(let day = 1; day <= daysInMonth; day++) {
                const isTodayMock = (day === state.currentDate.getDate() && state.currentDate.getMonth() === 10 && state.currentDate.getFullYear() === 2025);
                const shiftMock = (day % 4 === 0) ? `<div class="bg-teal-200 text-teal-800 text-[10px] rounded px-1 mt-1 font-medium">4 Shifts (${dayNamesFull[day % 7].substring(0,2)})</div>` : '';

                cellsHTML += `
                    <div class="calendar-cell ${isTodayMock ? 'border-2 border-teal-500 bg-teal-50' : 'bg-white'}">
                        <div class="text-xs font-bold mb-1">${day}</div>
                        ${shiftMock}
                    </div>
                `;
            }
            
            container.innerHTML = headerHTML + cellsHTML;
            container.classList.add('grid');
        }
        
        function renderYearView() {
            const container = document.getElementById('year-month-grid');
            container.innerHTML = '';
            
            let monthsHTML = '';
            const currentYear = state.currentDate.getFullYear();
            document.getElementById('year-display').textContent = currentYear;

            for(let i = 0; i < 12; i++) {
                const totalHoursMock = 120 + Math.floor(Math.random() * 50);
                const costPercentMock = (25 + Math.random() * 5).toFixed(1);
                
                monthsHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-100">
                        <h5 class="font-bold text-gray-800 mb-2">${monthNames[i]} ${currentYear}</h5>
                        <p class="text-sm text-gray-500">Gewerkte uren: <span class="font-bold text-teal-600">${totalHoursMock}</span></p>
                        <p class="text-sm text-gray-500">Loonkosten %: <span class="font-bold ${parseFloat(costPercentMock) > 28 ? 'text-red-500' : 'text-green-600'}">${costPercentMock}%</span></p>
                        <p class="text-xs text-indigo-600 mt-2">${Math.floor(Math.random() * 8)} FairShift Bonussen</p>
                    </div>
                `;
            }
            container.innerHTML = monthsHTML;
            container.classList.add('grid'); 
        }

        function renderWeekGrid() {
            const grid = document.getElementById('planning-grid');
            const employeesWithShifts = state.employees.filter(e => e.status === 'active');
            
            const startOfWeek = getStartOfWeek(state.currentDate);

            const planningHTML = employeesWithShifts.map(emp => {
                let rowHTML = `
                    <div class="grid grid-cols-8 py-2 items-center hover:bg-gray-50">
                        <div class="col-span-1 px-4 flex items-center gap-2 font-bold text-gray-700">
                            <img src="${emp.avatar}" alt="${emp.name}" class="w-8 h-8 rounded-full object-cover border border-gray-200">
                            <span class="text-sm">${emp.name}</span>
                        </div>
                `;
                
                for (let i = 0; i < 7; i++) {
                    // Calculate date for this column
                    const cellDate = new Date(startOfWeek);
                    cellDate.setDate(startOfWeek.getDate() + i);
                    const cellDateStr = toISODate(cellDate);

                    // Find matching shift in new data structure
                    const shift = state.shifts.find(s => {
                        if (s.empId !== emp.id) return false;
                        
                        // 1. If one-time shift, date must match
                        if (!s.recurring) {
                            return s.date === cellDateStr;
                        }

                        // 2. If recurring shift:
                        if (s.recurring && s.dayIndex === i) {
                            if (s.startDate && cellDateStr < s.startDate) return false;
                            if (s.endDate && cellDateStr > s.endDate) return false;
                            if (s.exceptions && s.exceptions.includes(cellDateStr)) return false;
                            return true;
                        }
                        
                        return false;
                    });
                    
                    if (shift) {
                        const isRecurringUI = shift.recurring ? '' : 'border-l-4 border-orange-400';
                        const bgColor = (i === 4 && emp.name === 'Sarah' && state.fairShiftActive) ? 'bg-red-200' : 'bg-teal-100';
                        
                        rowHTML += `
                            <div class="p-1" onclick="showShiftModal(${emp.id}, ${i}, '${shift.start}', '${shift.end}', ${shift.recurring}, '${cellDateStr}')">
                                <div class="${bgColor} ${isRecurringUI} text-teal-800 text-xs rounded p-1 text-center shadow-sm cursor-pointer hover:bg-teal-200 transition-colors relative group">
                                    ${shift.start.substring(0, 5)}<br>${shift.end.substring(0, 5)}
                                    ${!shift.recurring ? '<span class="absolute -top-1 -right-1 w-2 h-2 bg-orange-400 rounded-full"></span>' : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        rowHTML += `
                            <div class="p-1" onclick="showShiftModal(${emp.id}, ${i}, '', '', false, '${cellDateStr}')" title="Dienst Toevoegen">
                                <div class="bg-gray-100 text-gray-400 text-xs rounded p-1 text-center h-full flex items-center justify-center hover:bg-gray-200 transition-colors cursor-pointer min-h-[40px]">
                                    +
                                </div>
                            </div>
                        `;
                    }
                }
                
                rowHTML += `</div>`;
                return rowHTML;
            }).join('');
            
            grid.innerHTML = planningHTML;
        }

        // --- Personeel Logic (Toevoegen & Bewerken) ---

        function toggleAddForm() {
            const formContainer = document.getElementById('add-employee-form-container');
            formContainer.classList.toggle('hidden');
            if (!formContainer.classList.contains('hidden')) {
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function getNextAvatar(id) {
            const gender = id % 2 === 0 ? 'women' : 'men';
            const seed = 10 + (id % 90);
            return `https://randomuser.me/api/portraits/${gender}/${seed}.jpg`;
        }

        function addEmployee(event) {
            event.preventDefault();
            const form = event.target;
            
            const name = form.name.value.trim();
            const role = form.role.value.trim();
            const contract = form.contract.value.trim();
            const wage = parseFloat(form.wage.value);

            if (!name || !role || !contract || isNaN(wage) || wage <= 0) {
                showCustomAlert('Fout', 'Vul alstublieft alle velden correct in.');
                return;
            }

            const newEmployee = {
                id: state.nextEmployeeId++,
                name: name,
                role: role,
                status: 'active',
                avatar: getNextAvatar(state.nextEmployeeId),
                contract: contract,
                wage: wage
            };

            state.employees.push(newEmployee);
            
            renderEmployeeTable();
            form.reset();
            toggleAddForm();
            showCustomAlert('Succes!', `Medewerker ${name} is succesvol toegevoegd aan het systeem.`);
        }

        // EDIT EMPLOYEE FUNCTIONS
        function editEmployee(id) {
            const emp = state.employees.find(e => e.id === id);
            if (!emp) return;

            document.getElementById('edit-emp-id').value = emp.id;
            document.getElementById('edit-name').value = emp.name;
            document.getElementById('edit-role').value = emp.role;
            document.getElementById('edit-contract').value = emp.contract;
            document.getElementById('edit-wage').value = emp.wage;

            document.getElementById('edit-employee-modal').classList.remove('hidden');
        }

        function closeEditEmployeeModal() {
            document.getElementById('edit-employee-modal').classList.add('hidden');
        }

        function handleEditEmployeeSubmit(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('edit-emp-id').value);
            const name = document.getElementById('edit-name').value.trim();
            const role = document.getElementById('edit-role').value.trim();
            const contract = document.getElementById('edit-contract').value.trim();
            const wage = parseFloat(document.getElementById('edit-wage').value);

            if (!name || !role || !contract || isNaN(wage) || wage <= 0) {
                showCustomAlert('Fout', 'Vul alstublieft alle velden correct in.');
                return;
            }

            // Update in state
            const empIndex = state.employees.findIndex(e => e.id === id);
            if (empIndex > -1) {
                state.employees[empIndex].name = name;
                state.employees[empIndex].role = role;
                state.employees[empIndex].contract = contract;
                state.employees[empIndex].wage = wage;
                
                // Re-render relevant views
                renderEmployeeTable();
                renderRoster(); // In case name/role changed on dashboard
                if (state.activeView === 'planning') renderPlanningContent(); // In case name changed on planning grid
                if (state.activeView === 'verloning') renderPayroll(); // If editing in payroll view context (not direct here but logical)

                closeEditEmployeeModal();
                showCustomAlert('Opgeslagen', `Gegevens van ${name} zijn bijgewerkt.`);
            }
        }

        function renderEmployeeTable() {
            const tbody = document.getElementById('employee-table-body');
            const sortedEmployees = [...state.employees].sort((a, b) => a.name.localeCompare(b.name));
            
            tbody.innerHTML = sortedEmployees.map(emp => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 flex items-center gap-3">
                        <img src="${emp.avatar}" alt="${emp.name}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                        <span class="font-bold text-gray-700">${emp.name}</span>
                    </td>
                    <td class="p-4 text-gray-600">${emp.role}</td>
                    <td class="p-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${emp.contract}</span></td>
                    <td class="p-4 text-gray-700">‚Ç¨ ${emp.wage.toFixed(2).replace('.', ',')}</td>
                    <td class="p-4">
                        <span class="${emp.status === 'active' ? 'text-green-600' : 'text-red-600'} text-sm font-medium">
                            ‚óè ${emp.status === 'active' ? 'Actief' : 'Ziek'}
                        </span>
                    </td>
                    <td class="p-4 text-teal-600 hover:underline cursor-pointer" onclick="editEmployee(${emp.id})">Bewerk</td>
                </tr>
            `).join('');
        }
        
        // --- Shift Modals (CRUD) ---

        function showShiftModal(empId, dayIndex, start = '', end = '', recurring = false, dateStr = '') {
            if (state.activeView !== 'planning' || state.currentView !== 'week') return;

            currentShift = { empId, dayIndex, dateStr }; // Store context
            const emp = state.employees.find(e => e.id === empId);

            document.getElementById('shift-emp-id').value = empId;
            document.getElementById('shift-day-index').value = dayIndex;
            document.getElementById('shift-emp-name').textContent = emp.name;
            document.getElementById('shift-day-name').textContent = dayNamesFull[dayIndex] + (dateStr ? ` (${dateStr.split('-').reverse().join('-')})` : '');
            document.getElementById('shift-start').value = start ? start.substring(0, 5) : '';
            document.getElementById('shift-end').value = end ? end.substring(0, 5) : '';
            document.getElementById('shift-recurring').checked = recurring;

            const isExistingShift = start !== '' && end !== '';
            const deleteBtn = document.getElementById('shift-delete-btn');
            const sickBtn = document.getElementById('shift-sick-btn');
            const saveBtn = document.getElementById('shift-save-btn');

            if (isExistingShift) {
                deleteBtn.classList.remove('hidden');
                sickBtn.classList.remove('hidden'); // Show "Meld Ziek" button
                saveBtn.textContent = 'Dienst Wijzigen';
            } else {
                deleteBtn.classList.add('hidden');
                sickBtn.classList.add('hidden');
                saveBtn.textContent = 'Dienst Toevoegen';
            }

            document.getElementById('shift-modal').classList.remove('hidden');
        }
        
        function reportSickFromPlanning() {
             const { empId, dayIndex } = currentShift;
             const emp = state.employees.find(e => e.id === empId);
             
             if(!emp) return;

             // Set GLOBAL sick day index so replacement logic knows which day to target
             sickDayIndex = dayIndex;
             sickEmployeeId = empId;

             closeShiftModal();
             
             // Open the Action Modal directly
             document.getElementById('modal-employee-name').innerText = emp.name;
             document.getElementById('action-modal').classList.remove('hidden');
        }

        function closeShiftModal() {
            document.getElementById('shift-modal').classList.add('hidden');
            currentShift = {};
        }

        function handleShiftSubmit(event) {
            event.preventDefault();
            const empId = parseInt(document.getElementById('shift-emp-id').value);
            const dayIndex = parseInt(document.getElementById('shift-day-index').value);
            const start = document.getElementById('shift-start').value;
            const end = document.getElementById('shift-end').value;
            const isRecurring = document.getElementById('shift-recurring').checked;

            if (!start || !end) {
                 showCustomAlert('Fout', 'Vul een geldige start- en eindtijd in.');
                 return;
            }

            saveShift(empId, dayIndex, start, end, isRecurring);
            closeShiftModal();
            showCustomAlert('Succes', `Dienst is succesvol opgeslagen (${isRecurring ? 'Wekelijks' : 'Eenmalig'}).`);
        }

        function saveShift(empId, dayIndex, start, end, isRecurring) {
            // Remove existing shift on this slot first
            deleteShift(false); 

            const newShift = {
                empId: empId,
                dayIndex: dayIndex,
                start: start,
                end: end,
                recurring: isRecurring,
                date: isRecurring ? null : currentShift.dateStr,
                startDate: isRecurring ? currentShift.dateStr : null // Set start date based on current view
            };
            
            state.shifts.push(newShift);
            renderPlanningContent();
        }

        // NEW: Initiate delete process
        function initiateDeleteShift() {
            const { empId, dayIndex, dateStr } = currentShift;
            
            // Find the shift in state
            const shift = state.shifts.find(s => {
                if (s.empId !== empId) return false;
                // Check recurring match
                if (s.recurring && s.dayIndex === dayIndex) {
                     // Ensure it's valid for this date
                     if (s.startDate && dateStr < s.startDate) return false;
                     if (s.endDate && dateStr > s.endDate) return false;
                     if (s.exceptions && s.exceptions.includes(dateStr)) return false;
                     return true;
                }
                // Check one-time match
                if (!s.recurring && s.date === dateStr) return true;
                return false;
            });

            if (shift && shift.recurring) {
                // If recurring, show confirmation modal
                closeShiftModal(); // Hide edit modal first
                document.getElementById('delete-confirmation-modal').classList.remove('hidden');
            } else {
                // If one-time, just delete
                deleteShift();
            }
        }

        function closeDeleteConfirmation() {
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
        }

        function confirmDelete(mode) {
            const { empId, dayIndex, dateStr } = currentShift;
            closeDeleteConfirmation();

            // Find the active recurring shift to modify
            const shiftIndex = state.shifts.findIndex(s => {
                if (s.empId !== empId) return false;
                if (s.recurring && s.dayIndex === dayIndex) {
                     if (s.startDate && dateStr < s.startDate) return false;
                     if (s.endDate && dateStr > s.endDate) return false;
                     if (s.exceptions && s.exceptions.includes(dateStr)) return false;
                     return true;
                }
                return false;
            });

            if (shiftIndex > -1) {
                if (mode === 'single') {
                    // Add exception for this date
                    if (!state.shifts[shiftIndex].exceptions) state.shifts[shiftIndex].exceptions = [];
                    state.shifts[shiftIndex].exceptions.push(dateStr);
                    showCustomAlert('Verwijderd', 'Deze dienst is verwijderd voor deze week.');
                } else if (mode === 'future') {
                    // Set end date to yesterday
                    const yesterday = new Date(dateStr);
                    yesterday.setDate(yesterday.getDate() - 1);
                    state.shifts[shiftIndex].endDate = toISODate(yesterday);
                    showCustomAlert('Reeks Gestopt', 'Deze dienstreeks is be√´indigd vanaf vandaag.');
                }
                renderPlanningContent();
            }
            
            // Clear context after successful delete
            currentShift = {};
        }

        function deleteShift(refresh = true) {
            const { empId, dayIndex, dateStr } = currentShift;
            
            // Filter out the shift that matches the current context
            state.shifts = state.shifts.filter(s => {
                if (s.empId !== empId) return true;
                
                // Match one-time shift
                if (!s.recurring && s.date === dateStr) return false;
                
                // Match recurring shift ONLY if we are forcing a delete/replace (refresh=false)
                // Otherwise recurring shifts go through confirmDelete logic
                if (!refresh && s.recurring && s.dayIndex === dayIndex) {
                     // Basic check to ensure we are targeting the right active recurring shift
                     if (s.startDate && dateStr < s.startDate) return true;
                     if (s.endDate && dateStr > s.endDate) return true;
                     if (s.exceptions && s.exceptions.includes(dateStr)) return true;
                     return false; 
                }
                
                return true;
            });

            if (refresh) {
                closeShiftModal();
                renderPlanningContent();
                // Only show alert if called explicitly via button
                if(arguments.length === 0) showCustomAlert('Succes', 'Dienst is verwijderd.');
            }
        }
        
        // --- Payroll Logic (WEEK, MONTH, YEAR) ---

        function changePayrollView(newView) {
            state.payrollView = newView;
            // Update button styles
            document.querySelectorAll('#view-verloning button').forEach(btn => {
                 if(btn.id && btn.id.startsWith('pay-')) {
                     btn.classList.remove('bg-teal-600', 'text-white');
                     btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
                 }
            });
            const activeBtn = document.getElementById(`pay-${newView}-btn`);
            if(activeBtn) {
                activeBtn.classList.add('bg-teal-600', 'text-white');
                activeBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
            }
            renderPayroll();
        }

        function handlePayrollExport() {
            const view = state.payrollView;
            let msg = "";
            if(view === 'week') msg = "Loonstroken voor deze week worden gegenereerd.";
            if(view === 'month') msg = "Maandoverzicht wordt ge√´xporteerd voor boekhouding.";
            if(view === 'year') msg = "Jaaropgave 2025 wordt gegenereerd.";
            showCustomAlert('Export Gestart', msg);
        }

        function renderPayroll() {
            const tbody = document.getElementById('payroll-table-body');
            tbody.innerHTML = '';
            
            const view = state.payrollView;
            let startDate, endDate;
            let periodLabel = "";
            
            // 1. Determine Date Range based on view
            if (view === 'week') {
                // Use planning's current week logic
                startDate = getStartOfWeek(state.currentDate);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                const weekNum = getWeekNumber(startDate);
                periodLabel = `Loonstrook Details (Week ${weekNum})`;
                
            } else if (view === 'month') {
                startDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), 1);
                endDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 0);
                periodLabel = `Loonstrook Details (${monthNames[state.currentDate.getMonth()]} ${state.currentDate.getFullYear()})`;
                
            } else if (view === 'year') {
                startDate = new Date(state.currentDate.getFullYear(), 0, 1);
                endDate = new Date(state.currentDate.getFullYear(), 11, 31);
                periodLabel = `Jaaropgave (${state.currentDate.getFullYear()})`;
            }

            // Update UI Headers
            document.getElementById('payroll-title-period').innerText = periodLabel;
            
            let totalHoursAll = 0;
            let totalCostAll = 0;

            // 2. Iterate employees and calculate shifts in range
            state.employees.forEach(emp => {
                let empHours = 0;
                
                // Iterate every day in range
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                     const currentDayStr = toISODate(d);
                     // Day index for recurring check (0=Monday...6=Sunday) - JS getDay is 0=Sun
                     const jsDay = d.getDay(); 
                     const dayIndex = (jsDay === 0) ? 6 : jsDay - 1; 
                     
                     const shift = state.shifts.find(s => {
                        if (s.empId !== emp.id) return false;
                        
                        // Recurring logic
                        if (s.recurring && s.dayIndex === dayIndex) {
                             if (s.startDate && currentDayStr < s.startDate) return false;
                             if (s.endDate && currentDayStr > s.endDate) return false;
                             if (s.exceptions && s.exceptions.includes(currentDayStr)) return false;
                             return true;
                        }
                        // One-time logic
                        if (!s.recurring && s.date === currentDayStr) return true;
                        
                        return false;
                     });
                     
                     if(shift) {
                         empHours += getDuration(shift.start, shift.end);
                     }
                }
                
                const empCost = empHours * emp.wage;
                totalHoursAll += empHours;
                totalCostAll += empCost;
                
                // Only show rows if they have hours OR if it's a full month/year view (maybe show 0h for active staff)
                // Let's show all active employees for completeness in Month/Year
                if (empHours > 0 || view !== 'week') {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                            <td class="p-4 flex items-center gap-3">
                                <img src="${emp.avatar}" class="w-8 h-8 rounded-full object-cover">
                                <span class="font-bold text-gray-700">${emp.name}</span>
                            </td>
                            <td class="p-4 text-sm text-gray-600">${emp.role}</td>
                            <td class="p-4 text-sm text-gray-600">‚Ç¨ ${emp.wage.toFixed(2)}</td>
                            <td class="p-4 text-sm font-bold text-gray-800">${empHours.toFixed(1)} u</td>
                            <td class="p-4 text-sm font-bold text-teal-600">‚Ç¨ ${empCost.toFixed(2).replace('.', ',')}</td>
                        </tr>
                    `;
                }
            });
            
            if (state.employees.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-500">Geen medewerkers in systeem.</td></tr>`;
            }
            
            // Update KPI Cards
            document.getElementById('payroll-total-hours').innerText = totalHoursAll.toFixed(1) + ' u';
            document.getElementById('payroll-total-cost').innerText = '‚Ç¨ ' + totalCostAll.toFixed(2).replace('.', ',');
            
            // Update labels based on view
            if(view === 'week') {
                document.getElementById('payroll-cost-label').innerText = "Totale Loonkosten (Deze Week)";
                document.getElementById('payroll-export-btn').innerHTML = "<span>üìÑ</span> Export naar Salaris";
            } else if (view === 'month') {
                document.getElementById('payroll-cost-label').innerText = `Totale Loonkosten (${monthNames[state.currentDate.getMonth()]})`;
                document.getElementById('payroll-export-btn').innerHTML = "<span>üìä</span> Export Maandstaat";
            } else {
                document.getElementById('payroll-cost-label').innerText = `Totale Loonkosten (${state.currentDate.getFullYear()})`;
                document.getElementById('payroll-export-btn').innerHTML = "<span>üìö</span> Export Jaaropgave";
            }
        }

        // --- Dashboard Logic (Roster + FairShift) ---

        function renderRoster() {
            const container = document.getElementById('roster-list');
            container.innerHTML = '';
            const today = 4; // Vrijdag
            
            // Calculate correct date for Friday of the current viewing week
            const startOfWeek = getStartOfWeek(state.currentDate);
            const fridayDate = new Date(startOfWeek);
            fridayDate.setDate(startOfWeek.getDate() + 4);
            const fridayDateStr = toISODate(fridayDate);

            state.employees.forEach(emp => {
                // Check if employee has a shift today (Friday)
                const shift = state.shifts.find(s => {
                    if (s.empId !== emp.id) return false;
                    
                    if (s.recurring && s.dayIndex === today) {
                         if (s.startDate && fridayDateStr < s.startDate) return false;
                         if (s.endDate && fridayDateStr > s.endDate) return false;
                         if (s.exceptions && s.exceptions.includes(fridayDateStr)) return false;
                         return true;
                    }
                    
                    if (!s.recurring && s.date === fridayDateStr) return true;
                    return false;
                });

                if (!shift) return;

                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-4 rounded-lg border transition-all ${
                    emp.status === 'sick' ? 'bg-red-50 border-red-200 opacity-75' : 'bg-white border-gray-200 hover:border-teal-300'
                }`;
                let statusBadge = `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">Aanwezig</span>`;
                let actionBtn = `<button onclick="openSickModal('${emp.name}')" class="btn-danger">Meld Ziek</button>`;
                
                if (emp.status === 'sick') {
                    statusBadge = `<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">Ziek</span>`;
                    actionBtn = `<span class="text-xs text-red-500 font-medium italic">Afwezig gemeld</span>`;
                } else if (state.fairShiftActive) {
                    statusBadge = `<span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded font-bold flex items-center gap-1">‚ö° Bonus Actief</span>`;
                    actionBtn = `<span class="text-gray-400 text-xs">Ingeroosterd</span>`;
                }
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${emp.avatar}" alt="${emp.name}" class="w-10 h-10 rounded-full object-cover border border-gray-200 shadow-sm">
                        <div><p class="font-bold text-gray-800">${emp.name}</p><p class="text-xs text-gray-500">${emp.role} ‚Ä¢ ${shift.start} - ${shift.end}</p></div>
                    </div>
                    <div class="flex items-center gap-4">${statusBadge}${actionBtn}</div>
                `;
                container.appendChild(div);
            });
        }
        
        function updateDashboard() {
            document.getElementById('pot-display').innerText = `‚Ç¨ ${state.potTotal.toFixed(2).replace('.', ',')}`;
            const bonusElement = document.getElementById('mobile-fairshift-alert');
            const bonusAmountText = document.getElementById('mobile-bonus-amount');
            const earnedText = document.getElementById('mobile-earned');

            if (state.fairShiftActive) {
                const bonusPerPerson = calculateBonusPerPerson();
                bonusElement.classList.remove('hidden');
                bonusAmountText.innerText = `+ ‚Ç¨ ${bonusPerPerson.toFixed(2).replace('.', ',')}`;
                earnedText.innerText = `‚Ç¨ ${(30.38 + (bonusPerPerson * 2.25)).toFixed(2).replace('.', ',')}`;
                earnedText.className = 'font-bold text-indigo-600';
                document.getElementById('wage-percent').innerHTML = `28.5% <span class="text-xs font-normal text-gray-400">(Stabiel)</span>`;
                document.getElementById('sidebar-status').innerText = 'Actief (1 Ziek)';
                document.getElementById('sidebar-status').className = 'text-sm font-bold text-indigo-600';
            } else {
                bonusElement.classList.add('hidden');
                document.getElementById('sidebar-status').innerText = 'Actief (Demo Modus)';
                document.getElementById('sidebar-status').className = 'text-sm text-indigo-600';
            }
            updateChart();
            renderRoster();
        }

        // --- Demo State Management (FairShift & Replacement) ---

        function openReplacementModal() {
            // BUGFIX: We verbergen de action-modal handmatig in plaats van closeModal() te roepen.
            // closeModal() wist namelijk sickEmployeeId, wat we hier nog nodig hebben.
            document.getElementById('action-modal').classList.add('hidden');
            
            const sickEmp = state.employees.find(e => e.id === sickEmployeeId);
            
            // Veiligheidscheck
            if (!sickEmp) {
                console.error("Geen zieke medewerker geselecteerd.");
                return;
            }

            document.getElementById('replacement-sick-name').textContent = sickEmp.name;
            document.getElementById('replacement-modal').classList.remove('hidden');
            renderReplacementList();
        }

        function closeReplacementModal() {
            document.getElementById('replacement-modal').classList.add('hidden');
            sickEmployeeId = null;
            sickDayIndex = null; // Reset
            renderRoster();
        }

        function renderReplacementList() {
            const listContainer = document.getElementById('replacement-list');
            listContainer.innerHTML = '';
            
            // DYNAMISCH: Bepaal de datum van de dienst
            const startOfWeek = getStartOfWeek(state.currentDate);
            // Als sickDayIndex gezet is (vanuit planning), gebruik die. Anders default naar Vrijdag (4) voor Dashboard demo.
            const targetDayIndex = sickDayIndex !== null ? sickDayIndex : 4;
            
            const targetDate = new Date(startOfWeek);
            targetDate.setDate(startOfWeek.getDate() + targetDayIndex);
            const targetDateStr = toISODate(targetDate);
            
            // Filter logica: Wie is er VRIJ op deze specifieke dag?
            const colleaguesAvailable = state.employees.filter(emp => {
                // 1. Moet actief zijn en niet de zieke persoon zelf
                if (emp.status !== 'active' || emp.id === sickEmployeeId) return false;
                
                // 2. Check of deze persoon AL WERKT op deze dag
                const isWorkingToday = state.shifts.some(s => {
                     if (s.empId !== emp.id) return false;
                     
                     // Check terugkerende shift
                     if (s.recurring && s.dayIndex === targetDayIndex) {
                         // Check validity
                         if (s.startDate && targetDateStr < s.startDate) return false;
                         if (s.endDate && targetDateStr > s.endDate) return false;
                         if (s.exceptions && s.exceptions.includes(targetDateStr)) return false;
                         return true;
                     }
                     // Check eenmalige shift
                     if (!s.recurring && s.date === targetDateStr) return true;
                     
                     return false;
                });
                
                // Als ze werken (isWorkingToday is true), zijn ze NIET beschikbaar (!true = false)
                return !isWorkingToday;
            });
            
            if (colleaguesAvailable.length === 0) {
                listContainer.innerHTML = `<div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-100">
                    <p class="text-gray-500 text-sm mb-1 font-medium">Geen vervangers beschikbaar</p>
                    <p class="text-xs text-gray-400">Alle andere medewerkers zijn al ingeroosterd of niet actief op ${dayNamesFull[targetDayIndex]}.</p>
                </div>`;
                return;
            }

            colleaguesAvailable.forEach(emp => {
                const btn = document.createElement('button');
                btn.className = 'w-full flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200 hover:border-teal-500 hover:bg-teal-50 transition-all shadow-sm group text-left';
                btn.setAttribute('onclick', `replaceEmployee(${emp.id})`);
                
                btn.innerHTML = `
                    <div class="relative flex-shrink-0">
                        <img src="${emp.avatar}" alt="${emp.name}" class="w-10 h-10 rounded-full object-cover border border-gray-200 group-hover:border-teal-300">
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full" title="Beschikbaar"></span>
                    </div>
                    <div class="flex-1">
                        <span class="block font-bold text-gray-800 group-hover:text-teal-700">${emp.name}</span>
                        <div class="flex justify-between items-center">
                             <span class="text-xs text-gray-500">${emp.role}</span>
                             <span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">${emp.contract}</span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(btn);
            });
        }

        function replaceEmployee(replacementId) {
            const sickEmpIndex = state.employees.findIndex(e => e.id === sickEmployeeId);
            const sickEmp = state.employees[sickEmpIndex];
            
            // Mark sick (global status update)
            if (sickEmpIndex > -1) {
                state.employees[sickEmpIndex].status = 'sick';
            }
            
            // DYNAMISCH: Gebruik de juiste dag
            const targetDayIndex = sickDayIndex !== null ? sickDayIndex : 4;
            
            const startOfWeek = getStartOfWeek(state.currentDate);
            const targetDate = new Date(startOfWeek);
            targetDate.setDate(startOfWeek.getDate() + targetDayIndex);
            const targetDateStr = toISODate(targetDate);
            
            // Find original shift to copy its times
            // Logic updated to account for exceptions/dates
            const originalShift = state.shifts.find(s => {
                if (s.empId !== sickEmployeeId) return false;
                if (s.recurring && s.dayIndex === targetDayIndex) {
                     if (s.startDate && targetDateStr < s.startDate) return false;
                     if (s.endDate && targetDateStr > s.endDate) return false;
                     if (s.exceptions && s.exceptions.includes(targetDateStr)) return false;
                     return true;
                }
                if (!s.recurring && s.date === targetDateStr) return true;
                return false;
            });
            
            if (originalShift) {
                 // We create a NEW one-time shift for the replacement on that specific date
                 state.shifts.push({
                     empId: replacementId,
                     dayIndex: targetDayIndex,
                     start: originalShift.start,
                     end: originalShift.end,
                     recurring: false,
                     date: targetDateStr
                 });
                 
                 // Optioneel: Als de originele shift eenmalig was, verwijder hem dan
                 if (!originalShift.recurring) {
                     // delete logic here if needed, keeping it simple for now (sick status covers it visually usually)
                 }
            }
            
            state.potTotal = 0;
            state.fairShiftActive = false;
            
            closeReplacementModal();
            updateDashboard();
            renderPlanningContent(); // Update grid immediately
            
            const replacedEmp = state.employees.find(e => e.id === replacementId);
            showCustomAlert('Vervanging Gelukt!', `${replacedEmp.name} neemt de dienst van ${sickEmp.name} over op ${dayNamesFull[targetDayIndex]}.`);
        }

        function calculateBonusPerPerson() {
            if (!state.potTotal) return 0;
            
            const startOfWeek = getStartOfWeek(state.currentDate);
            const fridayDate = new Date(startOfWeek);
            fridayDate.setDate(startOfWeek.getDate() + 4);
            const fridayDateStr = toISODate(fridayDate);

            const activeCount = state.employees.filter(emp => {
                if (emp.status !== 'active') return false;
                return state.shifts.some(s => {
                     if (s.empId !== emp.id) return false;
                     if (s.recurring && s.dayIndex === 4) {
                         if (s.startDate && fridayDateStr < s.startDate) return false;
                         if (s.endDate && fridayDateStr > s.endDate) return false;
                         if (s.exceptions && s.exceptions.includes(fridayDateStr)) return false;
                         return true;
                     }
                     if (!s.recurring && s.date === fridayDateStr) return true;
                     return false;
                });
            }).length;
            
            return activeCount > 0 ? (state.potTotal / activeCount) / 6 : 0;
        }
        function openSickModal(name) {
            const emp = state.employees.find(e => e.name === name);
            if (!emp) return;
            sickEmployeeId = emp.id; // Store ID
            document.getElementById('modal-employee-name').innerText = name;
            document.getElementById('action-modal').classList.remove('hidden');
        }
        function closeModal() { 
            document.getElementById('action-modal').classList.add('hidden');
            sickEmployeeId = null; 
        }
        
        function activateFairShift() {
            const sarahIndex = state.employees.findIndex(e => e.id === sickEmployeeId);
            if(sarahIndex > -1) state.employees[sarahIndex].status = 'sick';
            state.potTotal = 72.00;
            state.fairShiftActive = true;
            closeModal();
            updateDashboard();
        }

        // --- Custom Alert Implementation ---
        function showCustomAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert-modal').classList.remove('hidden');
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').classList.add('hidden');
        }

        // --- Chart.js Implementation ---
        let costChart;
        function initChart() {
            const ctx = document.getElementById('costChart').getContext('2d');
            costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['17:00', '18:00', '19:00', '20:00', '21:00', '22:00'],
                    datasets: [
                        { label: 'Gepland', data: [120, 160, 200, 200, 160, 120], backgroundColor: 'rgba(209, 213, 219, 0.5)', borderRadius: 4, order: 2 },
                        { label: 'Gerealiseerd', data: [120, 160, 200, 200, 160, 120], backgroundColor: 'rgba(13, 148, 136, 0.8)', borderRadius: 4, order: 1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
            });
        }
        function updateChart() {
            if (state.fairShiftActive && costChart) {
                costChart.data.datasets[1].label = 'Incl. Bonus';
                costChart.data.datasets[1].backgroundColor = 'rgba(79, 70, 229, 0.8)';
                costChart.update();
            } else if (!state.fairShiftActive && costChart) {
                costChart.data.datasets[1].label = 'Gerealiseerd';
                costChart.data.datasets[1].backgroundColor = 'rgba(13, 148, 136, 0.8)';
                costChart.update();
            }
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            populateTimeSelects();
            renderPlanningHeader();
            renderRoster();
            initChart();
        });
    </script>
</body>
</html>